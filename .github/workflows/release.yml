name: Release

on:
  # Manual production release trigger
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no actual release)'
        required: false
        default: false
        type: boolean

  # Reusable workflow for dev/nightly releases
  workflow_call:
    inputs:
      npm_tag:
        description: 'NPM dist tag (e.g., dev, next, alpha, beta, or version number)'
        required: true
        type: string
      version_suffix:
        description: 'Version suffix (e.g., dev, nightly, alpha)'
        required: false
        type: string
        default: 'dev'

# Remove default permissions of GITHUB_TOKEN for security
# https://docs.github.com/en/actions/using-jobs/assigning-permissions-to-jobs
permissions: {}

jobs:
  # Production release job - runs semantic-release for automated versioning
  production-release:
    if: inputs.npm_tag == ''
    name: Production Release
    concurrency:
      group: release-production
      cancel-in-progress: false
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: ðŸ” Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: ðŸ”§ Setup environment
        run: corepack enable

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 24.10.0
          registry-url: 'https://registry.npmjs.org/'
          cache: 'pnpm'

      - name: ðŸ”„ Update npm for trusted publishing
        run: npm install -g npm@11.6.0

      - name: ðŸ”§ Configure registries
        run: |
          pnpm config set registry https://registry.npmjs.org
          npm config set registry https://registry.npmjs.org

      - name: ðŸ“¦ Install dependencies
        run: pnpm install

      - name: ðŸ›  Build package
        run: pnpm build && pnpm install

      - name: ðŸ§ª Run tests
        run: pnpm test

      - name: ðŸš€ Run semantic-release
        if: ${{ !inputs.dry_run }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: pnpm release

      - name: ðŸ” Dry run semantic-release
        if: ${{ inputs.dry_run }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: pnpm release --dry-run

  # Dev/Nightly release job - manual versioning with custom npm tag
  dev-release:
    if: inputs.npm_tag != ''
    name: Dev Release
    concurrency:
      group: release-dev-${{ inputs.npm_tag }}
      cancel-in-progress: false
    permissions:
      contents: write
      id-token: write
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: ðŸ” Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: ðŸ”§ Setup environment
        run: corepack enable

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 24.10.0
          registry-url: 'https://registry.npmjs.org/'
          cache: 'pnpm'

      - name: ðŸ”„ Update npm for trusted publishing
        run: npm install -g npm@11.6.0

      - name: ðŸ”§ Configure registries
        run: |
          pnpm config set registry https://registry.npmjs.org
          npm config set registry https://registry.npmjs.org

      - name: ðŸ“¦ Install dependencies
        run: pnpm install

      - name: ðŸ›  Build package
        run: pnpm build && pnpm install

      - name: ðŸ§ª Run tests
        run: pnpm test

      - name: ðŸ·ï¸ Generate dev version
        id: version
        run: |
          COMMIT_SHA=$(git rev-parse --short HEAD)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          
          # Generate version based on suffix
          if [ "${{ inputs.version_suffix }}" = "nightly" ]; then
            DEV_VERSION="${CURRENT_VERSION}-nightly.${TIMESTAMP}"
          else
            DEV_VERSION="${CURRENT_VERSION}-${{ inputs.version_suffix }}.${TIMESTAMP}.${COMMIT_SHA}"
          fi
          
          echo "version=${DEV_VERSION}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Publishing version: ${DEV_VERSION} with tag: ${{ inputs.npm_tag }}"

      - name: ðŸ“ Update package.json version
        run: |
          npm version ${{ steps.version.outputs.version }} --no-git-tag-version

      - name: ðŸš€ Publish to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          npm publish --tag ${{ inputs.npm_tag }} --access public --provenance

      - name: ðŸ·ï¸ Create git tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ steps.version.outputs.version }}" -m "Release v${{ steps.version.outputs.version }}"
          git push origin "v${{ steps.version.outputs.version }}"

      - name: âœ… Summary
        run: |
          echo "## ðŸŽ‰ Dev Release Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **NPM Tag:** \`${{ inputs.npm_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Install with:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "npm install @stencil/vitest@${{ inputs.npm_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
